<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Brian Mayo "><meta name=description content="Intro Continuing with my last project rq, I recently started to work on this project card: Implement interactive prompt. Let&amp;rsquo;s have a look how can we implement a text-based UI with rust.
The ANSI Standard Before we dive into the wonderful world of terminal emulators and text-based interfaces, we need to understand what the ANSI escape sequences are:
ANSI escape sequences are a standard for in-band signaling to control cursor location, color, font styling, and other options on video text terminals and terminal emulators."><meta name=keywords content="protium,protiumx,brian mayo,blog,software,engineering,rust,golang,typescript,javascript,development,rust,tui,terminal,rq,http"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://protiumx.dev/blog/posts/creating-a-text-based-ui-with-rust/><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,500;0,600;0,700;1,500;1,600;1,700" rel=stylesheet><title>Creating a Text-based UI with rust :: protiumx blog</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/blog/main.0443a2f8708de3de84dad049a62411de1c632501ee822638d5c1877dc8a45df2.css><link rel=apple-touch-icon sizes=180x180 href=/blog/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/blog/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/blog/favicon-16x16.png><link rel=manifest href=/blog/site.webmanifest><link rel=mask-icon href=/blog/safari-pinned-tab.svg color><link rel="shortcut icon" href=/blog/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="Creating a Text-based UI with rust"><meta itemprop=description content="Intro Continuing with my last project rq, I recently started to work on this project card: Implement interactive prompt. Let&rsquo;s have a look how can we implement a text-based UI with rust.
The ANSI Standard Before we dive into the wonderful world of terminal emulators and text-based interfaces, we need to understand what the ANSI escape sequences are:
ANSI escape sequences are a standard for in-band signaling to control cursor location, color, font styling, and other options on video text terminals and terminal emulators."><meta itemprop=datePublished content="2022-06-02T00:00:00+00:00"><meta itemprop=dateModified content="2022-06-02T00:00:00+00:00"><meta itemprop=wordCount content="1367"><meta itemprop=image content="https://protiumx.dev/blog/static/android-chrome-512x512.png"><meta itemprop=keywords content="rust,tui,terminal,rq,http,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://protiumx.dev/blog/static/android-chrome-512x512.png"><meta name=twitter:title content="Creating a Text-based UI with rust"><meta name=twitter:description content="Intro Continuing with my last project rq, I recently started to work on this project card: Implement interactive prompt. Let&rsquo;s have a look how can we implement a text-based UI with rust.
The ANSI Standard Before we dive into the wonderful world of terminal emulators and text-based interfaces, we need to understand what the ANSI escape sequences are:
ANSI escape sequences are a standard for in-band signaling to control cursor location, color, font styling, and other options on video text terminals and terminal emulators."><meta property="og:title" content="Creating a Text-based UI with rust"><meta property="og:description" content="Intro Continuing with my last project rq, I recently started to work on this project card: Implement interactive prompt. Let&rsquo;s have a look how can we implement a text-based UI with rust.
The ANSI Standard Before we dive into the wonderful world of terminal emulators and text-based interfaces, we need to understand what the ANSI escape sequences are:
ANSI escape sequences are a standard for in-band signaling to control cursor location, color, font styling, and other options on video text terminals and terminal emulators."><meta property="og:type" content="article"><meta property="og:url" content="https://protiumx.dev/blog/posts/creating-a-text-based-ui-with-rust/"><meta property="og:image" content="https://protiumx.dev/blog/static/android-chrome-512x512.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-02T00:00:00+00:00"><meta property="article:modified_time" content="2022-06-02T00:00:00+00:00"><meta property="article:published_time" content="2022-06-02 00:00:00 +0000 UTC"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>$ cat protiumx/blog</span>
<span class=logo__cursor style=background-color:#c7157a></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://protiumx.dev target=_blank>about</a></li><li><a href=https://github.com/protiumx target=_blank>github</a></li><li><a href=/blog/posts/>posts</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>7 minutes</p></div><article><h1 class=post-title><a href=https://protiumx.dev/blog/posts/creating-a-text-based-ui-with-rust/>Creating a Text-based UI with rust</a></h1><div class=post-content><h2 id=intro>Intro</h2><p>Continuing with my last project <a href=https://github.com/protiumx/rq>rq</a>, I recently started to work on
this project card: <a href=https://github.com/protiumx/rq/projects/1#card-82259239>Implement interactive prompt</a>.
Let&rsquo;s have a look how can we implement a <strong>text-based UI</strong> with <code>rust</code>.</p><h2 id=the-ansi-standard>The ANSI Standard</h2><p>Before we dive into the wonderful world of terminal emulators and text-based interfaces,
we need to understand what the <strong>ANSI escape sequences</strong> are:</p><blockquote><p>ANSI escape sequences are a standard for in-band signaling to control cursor location, color, font styling, and other options on video text terminals and terminal emulators.</p><p>Source: <a href=https://en.wikipedia.org/wiki/ANSI_escape_code>https://en.wikipedia.org/wiki/ANSI_escape_code</a></p></blockquote><p>By using ANSI sequences we can tell the terminal emulator how to render text, change the cursor position,
clear the screen, etc. In my last <a href=https://dev.to/protium/my-profile-website-is-now-a-terminal-2j57>post</a>
I used these sequences to implement a very basic shell for my <a href=https://protiumx.dev>profile website</a>.</p><p>Let&rsquo;s see some examples. Head to your favorite terminal emulator (I use <a href=https://sw.kovidgoyal.net/kitty/>kitty</a>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>echo <span style=color:#e6db74>&#34;\x1b[35;47mANSI? \x1b[0m\x1b[1;32mSI&#34;</span>
</span></span></code></pre></div><p><img src=./ansi.png alt="echo ANSI"></p><p>Analysis:</p><ul><li><code>\x1b</code>: this is the hexadecimal for <code>ESC</code> (escape). It starts the escape sequence</li><li><code>[</code>: is the <a href=https://en.wikipedia.org/wiki/ANSI_escape_code#CSIsection>control sequence introducer</a></li><li><code>35;47m</code>: the SGR (Select Graphic Rendition) where <code>35</code> sets the <code>foreground</code> color to magenta and
<code>47</code> sets the <code>background</code> to white. <code>m</code> is the final character specified by the standard</li><li><code>\x1b[0m</code>: it&rsquo;s a special sequence to reset or turn all attributes off</li><li><code>\x1b[1;32m</code>: Sets foreground to green and add the <code>bold</code> attribute</li></ul><p>Lets try this in rust:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rs data-lang=rs><span style=display:flex><span>println!(<span style=color:#e6db74>&#34;\x1b[35;47mANSI? \x1b[0m\x1b[1;32mSI&#34;</span>);
</span></span></code></pre></div><p>It should have the same result as with the <code>echo</code> command above.</p><p>Another example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rs data-lang=rs><span style=display:flex><span>println!(<span style=color:#e6db74>&#34;\x1b[2J&#34;</span>);
</span></span></code></pre></div><p>According to the standard <code>[2J</code> erases entire display.</p><h2 id=designing-the-text-based-interface>Designing the text-based interface</h2><p>As a loyal user of (neo)vim, I love the concept of buffers. I want my app to have 2 buffers,
one for the list of HTTP requests and one for the current response:</p><p><img src=./design.jpg alt="design preview"></p><p>Let&rsquo;s start from scratch. To enter into the &ldquo;interactive&rdquo; mode, we need to clear the whole screen.
For that we will use the following escape sequences:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>println!(<span style=color:#e6db74>&#34;\r\x1b[2J\r\x1b[H&#34;</span>);
</span></span></code></pre></div><p><img src=https://media.giphy.com/media/l3q2K5jinAlChoCLS/giphy.gif alt=wut></p><ol><li><code>\r</code>, carriage return. We go all the way to the left</li><li>As explained before, <code>[2J</code> clears the entire screen</li><li><code>[H</code> moves the cursor to <code>home</code>, or the corner top-left of the terminal (col 1, row 1).</li></ol><p>Nice, an empty screen.
Next I want to draw the requests the program loaded from the <code>http</code> file
(for context: I have published this <a href=https://protiumx.dev/blog/posts/an-http-request-parser-with-rust-and-pest.rs/>article</a>
about how to parse HTTP request with rust). Based on the design, the selected request should print the
HTTP method in green, URL in white and body in orange. If the request is selected, the whole request line should be green.
Let&rsquo;s write a helper function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>draw_request</span>(req: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>HttpRequest</span>) -&gt; String {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> request_line <span style=color:#f92672>=</span> format!(<span style=color:#e6db74>&#34;{} {} HTTP/{}&#34;</span>, colorize(Color::Green, req.method), req.url, req.version);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>!</span>req.header.is_empty() {
</span></span><span style=display:flex><span>    request_line <span style=color:#f92672>=</span> format!(<span style=color:#e6db74>&#34;{}\r\n{:?}\r\n&#34;</span>, request_line, req.headers);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>!</span>req.body.is_empty() {
</span></span><span style=display:flex><span>    request_line <span style=color:#f92672>=</span> format!(<span style=color:#e6db74>&#34;{}\n{}&#34;</span>, request_line, colorize(Color::Orange, req.body.as_str()));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If you followed along my last post, you may have an idea of what the <code>colorize</code> function looks like.</p><p>Now we are able to print all the request. Since we will use <code>></code> to visually mark which request is
selected, we need to cater some space for it, hence we will print two empty spaces before each request start:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>for</span> req <span style=color:#66d9ef>in</span> http_file.requests {
</span></span><span style=display:flex><span>  println!(<span style=color:#e6db74>&#34;  {}\n&#34;</span>, draw(<span style=color:#f92672>&amp;</span>req));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// go home 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>println!(<span style=color:#e6db74>&#34;\x1b[H&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#75715e>// print the cursor &gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>print!(<span style=color:#e6db74>&#34;\x1b[32m&gt;&#34;</span>);
</span></span></code></pre></div><p>Results:
<img src=./request.png alt="print request"></p><h2 id=user-interaction>User interaction</h2><p>The user should be able to navigate between requests with the <strong>arrow keys</strong>. To achieve this we will need:</p><ul><li>Track the current cursor position (column and row)</li><li>Move the cursor down or up according to the user input</li><li>Redraw the interface (clean the screen and draw)</li></ul><p>We can compare this flow to how a game engine works: we evaluate changes and use the engine to draw the game
in its current state.</p><p>Since I want to finish this project in less than a month, I have decided to take a look at the different
options in <code>rust</code> for building a <code>TUI</code>. There are a few options that I can use as a TUI &ldquo;engine&rdquo;.</p><p>I opted for <a href=https://github.com/fdehau/tui-rs/>tui-rs</a> which is being used by some of my favorite
terminal apps like <a href=https://github.com/ClementTsang/bottom>bottom</a>. I headed over the <a href=https://github.com/fdehau/tui-rs/tree/master/examples>examples</a>
and used the <code>list</code> example as a base.</p><p>After a small refactor:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>ui</span><span style=color:#f92672>&lt;</span>B: <span style=color:#a6e22e>Backend</span><span style=color:#f92672>&gt;</span>(f: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>mut</span> Frame<span style=color:#f92672>&lt;</span>B<span style=color:#f92672>&gt;</span>, app: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>mut</span> App) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Split the screen into 2 vertical portions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>let</span> chunks <span style=color:#f92672>=</span> Layout::default()
</span></span><span style=display:flex><span>      .direction(Direction::Horizontal)
</span></span><span style=display:flex><span>      .constraints([Constraint::Percentage(<span style=color:#ae81ff>50</span>), Constraint::Percentage(<span style=color:#ae81ff>50</span>)].as_ref())
</span></span><span style=display:flex><span>      .split(f.size());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> items: Vec<span style=color:#f92672>&lt;</span>ListItem<span style=color:#f92672>&gt;</span> <span style=color:#f92672>=</span> app
</span></span><span style=display:flex><span>      .requests
</span></span><span style=display:flex><span>      .iter()
</span></span><span style=display:flex><span>      .map(<span style=color:#f92672>|</span>req<span style=color:#f92672>|</span> ListItem::new(draw_request(req)))
</span></span><span style=display:flex><span>      .collect();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> list_block <span style=color:#f92672>=</span> Block::default().borders(Borders::ALL).title(<span style=color:#e6db74>&#34;Requests&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> list <span style=color:#f92672>=</span> List::new(items)
</span></span><span style=display:flex><span>      .highlight_style(
</span></span><span style=display:flex><span>          Style::default()
</span></span><span style=display:flex><span>              .add_modifier(Modifier::BOLD)
</span></span><span style=display:flex><span>              .fg(Color::Green),
</span></span><span style=display:flex><span>      )
</span></span><span style=display:flex><span>      .highlight_symbol(<span style=color:#e6db74>&#34;&gt; &#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  f.render_stateful_widget(list.block(list_block), chunks[<span style=color:#ae81ff>0</span>], <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> app.list);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>So we are at the same point as when using ANSI escape sequences to render the UI.
This time we can easily implement a key handler and deal with the user interaction:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>match</span> event::read()<span style=color:#f92672>?</span> {
</span></span><span style=display:flex><span>    Event::Key(key) <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>match</span> key.code {
</span></span><span style=display:flex><span>        KeyCode::Down <span style=color:#f92672>=&gt;</span> app.next(),
</span></span><span style=display:flex><span>        KeyCode::Up <span style=color:#f92672>=&gt;</span> app.previous(),
</span></span><span style=display:flex><span>        _ <span style=color:#f92672>=&gt;</span> {}
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>where <code>app</code> is an instance of the <code>App</code> struct:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>App</span> {
</span></span><span style=display:flex><span>    list: <span style=color:#a6e22e>ListState</span>, <span style=color:#75715e>// from tui-rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    requests: Vec<span style=color:#f92672>&lt;</span>HttpRequest<span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>    response_buffer: String,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> App {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>next</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> i <span style=color:#f92672>=</span> self.list.selected().unwrap() <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> i <span style=color:#f92672>&gt;=</span> self.requests.len() {
</span></span><span style=display:flex><span>            i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self.list.select(Some(i));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>previous</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> i <span style=color:#f92672>=</span> self.list.selected().unwrap();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> i <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            i <span style=color:#f92672>=</span> self.requests.len() <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            i <span style=color:#f92672>-=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        self.list.select(Some(i));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Sweet! Now it is possible to navigate between requests:
<img src=./navigation.gif alt=navigation></p><h2 id=sending-http-requests>Sending HTTP requests</h2><p>Once the app is interactive and we can select a request, we can implement a handler for the <code>Enter</code> key as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// impl App ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>selected_request</span>(<span style=color:#f92672>&amp;</span>self) -&gt; <span style=color:#a6e22e>HttpRequest</span> {
</span></span><span style=display:flex><span>    self.requests[self.list.selected().unwrap()].clone()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//....
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>KeyCode::Enter <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> req <span style=color:#f92672>=</span> app.seleted_request();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> data <span style=color:#f92672>=</span> <span style=color:#66d9ef>match</span> rq_core::request::execute(<span style=color:#f92672>&amp;</span>req).<span style=color:#66d9ef>await</span> {
</span></span><span style=display:flex><span>    Ok(r) <span style=color:#f92672>=&gt;</span> r,
</span></span><span style=display:flex><span>    Err(e) <span style=color:#f92672>=&gt;</span> e.to_string(),
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  app.response_buffer <span style=color:#f92672>=</span> data;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I have implemented the <code>execute</code> function in the last post, you can take a look at the source <a href=https://github.com/protiumx/rq/blob/main/rq-core/src/request.rs>here</a>.</p><p>The UI is practically finished: the user can navigate with arrow keys and hit <code>Enter</code> to execute a request.</p><h2 id=bonus-multi-threading>Bonus: Multi-threading</h2><p>The problem we are facing now is that, even though the request is executed <code>async</code> with <code>tokio</code>, it is
blocking the main thread because we are <code>awaiting</code> it. If we send a slow request, the UI won&rsquo;t receive updates nor
key events until the request is done.</p><p>A proper solution would be to <code>spawn</code> a new thread to perform the request and assign the response to the app <code>response_buffer</code> once it finishes.
If you have worked before with a compiled language like <code>C++</code> or <code>C#</code>, you will know that we need to access to
the <code>app</code> variable in a <strong>thread-safe</strong> way by using a <code>mutex</code> (mutual exclusion object):
In short, we want to <strong>block</strong> any other thread from accessing to the <code>app</code> state at the same time that we want to change it.</p><p>Furthermore, we also need to take into account the lifetime checks made by the rust compiler.
If we simply <strong>move</strong> a variable into a new thread, its ownership is moved and thus the variable is killed once
the thread finishes. The solution? use a <code>pointer</code> to &ldquo;leak&rdquo; the <code>app</code> variable into another thread.</p><p>Without entering into details that are out of the scope of this article, I will use an <a href=https://doc.rust-lang.org/std/sync/struct.Arc.html>Atomically Reference Counted</a>,
from the rust <strong>standard library</strong>, to create a shared pointer of a <code>Mutex</code>. The multi-thread implementation looks like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// app_arc: Arc&lt;tokio::sync::Mutex&lt;App&gt;&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>KeyCode::Enter <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// create a new reference
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>let</span> app_arc <span style=color:#f92672>=</span> app_arc.clone();
</span></span><span style=display:flex><span>  tokio::spawn(<span style=color:#66d9ef>async</span> <span style=color:#66d9ef>move</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// the ownership of app_arc was now moved into this thread
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>let</span> data <span style=color:#f92672>=</span> <span style=color:#66d9ef>match</span> rq_core::request::execute(<span style=color:#f92672>&amp;</span>req).<span style=color:#66d9ef>await</span> {
</span></span><span style=display:flex><span>          Ok(r) <span style=color:#f92672>=&gt;</span> r,
</span></span><span style=display:flex><span>          Err(e) <span style=color:#f92672>=&gt;</span> e.to_string(),
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>      <span style=color:#75715e>// here we use the tokio Mutex to lock our variable since we want to write data into it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>let</span> app <span style=color:#f92672>=</span> app_arc.lock().<span style=color:#66d9ef>await</span>;
</span></span><span style=display:flex><span>      app.response_buffer <span style=color:#f92672>=</span> data;
</span></span><span style=display:flex><span>      <span style=color:#75715e>// at this point the thread exists and app_arc is killed.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// app is also killed, unlocking it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The result:
<img src=./result.gif alt=result></p><p>As you can see, we can navigate while a request is being executed. The UI keeps responsive. Perfect!</p><p>This is it for today, I hope you learned something new.</p><p>You can check out the repo <a href=https://github.com/protiumx/rq>here</a>.
If you would like to collaborate with this project there are some TODOs over <a href=https://github.com/protiumx/rq/projects/1>here</a>.</p><p>Thanks for reading!</p><p><strong>Other articles:</strong></p><ul><li><a href=https://protiumx.dev/blog/posts/my-profile-website-is-now-a-terminal/>My profile website is now a terminal</a></li><li><a href=https://protiumx.dev/blog/posts/an-http-request-parser-with-rust-and-pest.rs/>An HTTP request parser with rust and pest.rs</a></li><li>My dotfiles: <a href=https://github.com/protiumx/.dotfiles>https://github.com/protiumx/.dotfiles</a></li><li>My blog source: <a href=https://github.com/protiumx/blog>https://github.com/protiumx/blog</a></li></ul><p>üëΩ</p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://protiumx.dev/blog/tags/rust/>rust</a></span>
<span class=tag><a href=https://protiumx.dev/blog/tags/tui/>tui</a></span>
<span class=tag><a href=https://protiumx.dev/blog/tags/terminal/>terminal</a></span>
<span class=tag><a href=https://protiumx.dev/blog/tags/rq/>rq</a></span>
<span class=tag><a href=https://protiumx.dev/blog/tags/http/>http</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>1367 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2022-22-06</p></div><hr><div class=sharing-buttons><a class=resp-sharing-button__link href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fprotiumx.dev%2fblog%2fposts%2fcreating-a-text-based-ui-with-rust%2f" target=_blank rel=noopener aria-label title="Share on facebook"><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://twitter.com/intent/tweet/?url=https%3a%2f%2fprotiumx.dev%2fblog%2fposts%2fcreating-a-text-based-ui-with-rust%2f" target=_blank rel=noopener aria-label title="Share on twitter"><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fprotiumx.dev%2fblog%2fposts%2fcreating-a-text-based-ui-with-rust%2f&title=Creating%20a%20Text-based%20UI%20with%20rust&summary=Creating%20a%20Text-based%20UI%20with%20rust&source=https%3a%2f%2fprotiumx.dev%2fblog%2fposts%2fcreating-a-text-based-ui-with-rust%2f" target=_blank rel=noopener aria-label title="Share on linkedin"><div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></div></div></a><a class=resp-sharing-button__link href="https://reddit.com/submit/?url=https%3a%2f%2fprotiumx.dev%2fblog%2fposts%2fcreating-a-text-based-ui-with-rust%2f&resubmit=true&title=Creating%20a%20Text-based%20UI%20with%20rust" target=_blank rel=noopener aria-label title="Share on reddit"><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none"><path d="M12 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0zm5.01 4.744c.688.0 1.25.561 1.25 1.249a1.25 1.25.0 01-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968.0 1.754.786 1.754 1.754.0.716-.435 1.333-1.01 1.614a3.111 3.111.0 01.042.52c0 2.694-3.13 4.87-7.004 4.87s-7.004-2.176-7.004-4.87c0-.183.015-.366.043-.534A1.748 1.748.0 014.028 12c0-.968.786-1.754 1.754-1.754.463.0.898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342.0 01.14-.197.35.35.0 01.238-.042l2.906.617a1.214 1.214.0 011.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687.0 1.248-.561 1.248-1.249S9.937 12 9.249 12zm5.5.0c-.687.0-1.248.561-1.248 1.25.0.687.561 1.248 1.249 1.248S16 13.937 16 13.249c0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327.0 00-.231.094.33.33.0 000 .463c.842.842 2.484.913 2.961.913s2.105-.056 2.961-.913a.361.361.0 00.029-.463.33.33.0 00-.464.0c-.547.533-1.684.73-2.512.73-.828.0-1.979-.196-2.512-.73a.326.326.0 00-.232-.095z"/></svg></div></div></a></div><div class=pagination><div class=pagination__buttons><span class="button previous"><a href=https://protiumx.dev/blog/posts/github-template-for-golang-services/><span class=button__icon>‚Üê</span>
<span class=button__text>Github template for Golang services</span></a></span>
<span class="button next"><a href=https://protiumx.dev/blog/posts/my-profile-website-is-now-a-terminal/><span class=button__text>My profile website is now a terminal</span>
<span class=button__icon>‚Üí</span></a></span></div></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2022</span>
<span><a href=https://protiumx.dev/blog/>Brian Mayo</a></span>
<span><a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></span>
<span><a href=https://protiumx.dev/blog/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div></footer></div><script type=text/javascript src=/blog/bundle.min.bb2c6bc3ed452ca4759660e4020811f248bc2320081559e8a32d8b0092773852941133639d35e8370d03d3ddaa750b1edd6b343c5bd22a55d5bdeae8f648f49b.js integrity="sha512-uyxrw+1FLKR1lmDkAggR8ki8IyAIFVnooy2LAJJ3OFKUETNjnTXoNw0D092qdQse3Ws0PFvSKlXVvero9kj0mw=="></script></body></html>